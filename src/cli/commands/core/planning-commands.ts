import { SlashCommand } from '../../../types/command.js'
import type { ToolUseContext } from '../../../Tool.js'
import { AgentContext } from '../../../types/agent.js'
import { extractOption } from './utils.js'

/**
 * 规划类命令：outline, specify, plan, task
 * 负责文章规划、大纲生成、内容计划和任务分解
 */
export const planningCommands: SlashCommand[] = [
  {
    type: 'prompt',
    name: 'outline',
    description: '生成文章大纲',
    aliases: ['大纲', 'ol'],
    usage: '/outline <主题> [选项]',
    examples: [
      '/outline AI代理技术发展趋势',
      '/outline 微服务架构设计 --style=技术 --length=3000'
    ],
    
    async getPromptForCommand(_args: string, _context: AgentContext): Promise<string> {
      const [topic, ...options] = _args.split(' ')
      const style = extractOption(options, 'style') || '技术性'
      const length = extractOption(options, 'length') || '2000'
      
      return `请为主题"${topic}"生成详细的${style}文章大纲：

目标字数：${length}字
写作风格：${style}
目标读者：技术人员

请生成包含以下结构的大纲：
1. 吸引人的标题建议（3个备选）
2. 文章引言（核心问题和价值）
3. 主体章节（3-5个主要部分）
   - 每个章节的核心论点
   - 预估字数分配
   - 关键支撑材料
4. 结论部分（总结和展望）
5. 写作建议和注意事项

请确保大纲逻辑清晰，易于执行。`
    },
    
    allowedTools: ['web_search', 'read_article', 'write_article', 'citation_manager'],
    progressMessage: '正在生成文章大纲',
    userFacingName: () => 'outline'
  },

  {
    type: 'prompt',
    name: 'specify',
    description: '智能生成写作规范',
    aliases: ['规范', '写作规范', 'spec'],
    usage: '/specify <主题描述>',
    examples: [
      '/specify "人工智能技术发展趋势分析"',
      '/specify "我的创业经验分享"',
      '/specify "React性能优化最佳实践"',
      '/specify "公司数字化转型策略报告"'
    ],
    
    async getPromptForCommand(_args: string, _context: AgentContext): Promise<string> {
      const topic = _args.trim()
      
      if (!topic) {
        throw new Error('请提供写作主题。用法: /specify <主题描述>')
      }

      return `请分析以下写作需求并生成详细的写作规范：

主题：${topic}

## 🎯 任务要求

### 阶段1: 智能意图分析
首先分析用户的写作意图，识别：
- 写作类型（技术文章/研究报告/博客文章/商业文档/教程指南/案例研究）
- 目标读者群体
- 写作目的和核心价值
- 主题领域和专业深度

### 阶段2: 生成写作规范
基于意图分析结果，生成以下格式的详细写作规范：

# 📋 [${topic}] 写作规范

## 🎯 基础信息
- **写作类型**: [自动识别的写作类型]
- **主题领域**: [具体领域]
- **目标读者**: [详细读者画像]
- **写作目的**: [核心目标和价值]
- **预估字数**: [字数范围]
- **难度级别**: [入门/中级/高级/专家]

## 📝 内容规划
### 核心观点
- [主要观点1]
- [主要观点2] 
- [主要观点3]

### 文章结构
1. **引言部分** ([预估字数]字)
   - 问题背景介绍
   - 文章价值说明
   - 内容概览

2. **主体章节**
   - **第一部分**: [章节标题] ([预估字数]字)
   - **第二部分**: [章节标题] ([预估字数]字)
   - **第三部分**: [章节标题] ([预估字数]字)

3. **结论部分** ([预估字数]字)
   - 核心观点总结
   - 实践建议
   - 未来展望

## 📊 写作要求
### 语言风格
- **语调**: [正式/轻松/专业/通俗等]
- **术语使用**: [专业术语程度]
- **举例要求**: [是否需要具体案例]

### 质量标准
- **逻辑性**: 论述逻辑清晰，层次分明
- **准确性**: 事实数据准确，引用可靠
- **实用性**: 提供可操作的建议或见解
- **原创性**: 有独特观点或新颖角度

### 格式规范
- **标题格式**: [标题层级和格式要求]
- **代码示例**: [是否需要代码，格式要求]
- **图表要求**: [是否需要图表说明]
- **引用格式**: [参考文献格式]

## ✅ 写作检查清单
- [ ] 是否明确目标读者并针对性写作
- [ ] 核心观点是否清晰表达
- [ ] 文章结构是否逻辑合理
- [ ] 是否提供实用价值
- [ ] 语言表达是否符合风格要求
- [ ] 事实数据是否准确可靠
- [ ] 是否达到预期字数范围

## 💡 写作建议
[基于主题特点提供的具体写作建议和注意事项]

---

**📌 下一步操作建议：**
完成写作规范后，建议使用以下命令继续工作流：
1. \`/plan\` - 基于此规范生成详细内容计划
2. \`/task\` - 将计划分解为具体写作任务
3. \`/write <具体任务>\` - 执行具体的写作任务

请严格按照上述格式生成完整的写作规范，确保规范具体可行且针对性强。`
    },
    
    allowedTools: [
      'web_search', 'fact_checker', 'citation_manager', 
      'write_article', 'research_analyzer'
    ],
    progressMessage: '正在分析写作需求并生成规范...',
    userFacingName: () => 'specify'
  },

  {
    type: 'prompt',
    name: 'plan',
    description: '基于规范生成详细内容计划（进入Plan模式）',
    aliases: ['计划', '内容计划', 'content-plan'],
    usage: '/plan [基于前一步规范] 或 /plan <规范内容>',
    examples: [
      '/plan',
      '/plan 基于刚才生成的写作规范',
      '/plan 请为技术文章"React性能优化"生成计划'
    ],
    
    async getPromptForCommand(_args: string, _context: AgentContext): Promise<string> {
      const planInput = _args.trim()
      
      return `请基于写作规范生成详细的内容计划：

${planInput ? `计划输入：${planInput}` : '请基于之前生成的写作规范或提供的规范内容生成详细计划。'}

## 🎯 内容计划生成要求

### 阶段1: 规范理解和分析
- 仔细分析写作规范中的所有要求
- 理解目标读者、写作目的和核心观点
- 掌握文章结构和字数分配

### 阶段2: 详细内容计划
生成以下格式的详细内容计划：

# 📋 详细内容计划

## 📝 写作大纲
### 1. 引言部分 ([预估字数]字 | [预估时间]分钟)
**核心目标**: [明确引言的核心目标]
**主要内容**:
- 开篇钩子：[吸引读者的开篇方式]
- 问题陈述：[要解决的核心问题]
- 价值说明：[读者能获得什么价值]
- 文章导航：[内容结构预览]

**写作要点**:
- [具体写作建议1]
- [具体写作建议2]
- [需要注意的点]

### 2. 主体部分
#### 2.1 第一章节：[章节标题] ([预估字数]字 | [预估时间]分钟)
**核心论点**: [这一章节要表达的核心观点]
**内容要素**:
- 概念解释：[需要解释的关键概念]
- 实例支撑：[具体案例或数据]
- 分析论述：[深度分析和见解]

**写作策略**:
- [写作方法建议]
- [论证逻辑建议]
- [素材收集方向]

#### 2.2 第二章节：[章节标题] ([预估字数]字 | [预估时间]分钟)
**核心论点**: [这一章节要表达的核心观点]
**内容要素**:
- [章节具体内容要素]
- [支撑材料类型]
- [论证方式]

**写作策略**:
- [具体写作建议]

#### 2.3 第三章节：[章节标题] ([预估字数]字 | [预估时间]分钟)
**核心论点**: [这一章节要表达的核心观点]
**内容要素**:
- [章节具体内容要素]

### 3. 结论部分 ([预估字数]字 | [预估时间]分钟)
**核心目标**: [结论要达成的目标]
**主要内容**:
- 核心观点回顾：[主要论点总结]
- 实践指导：[可操作的建议]
- 未来展望：[趋势预测或发展方向]
- 行动号召：[希望读者采取的行动]

## 📊 写作时间安排
- **总预估时间**: [X小时Y分钟]
- **引言写作**: [时间分配]
- **主体写作**: [时间分配]
- **结论写作**: [时间分配]
- **修改润色**: [时间分配]

## 📚 素材准备清单
### 研究资料
- [ ] [具体需要的资料类型1]
- [ ] [具体需要的资料类型2]
- [ ] [具体需要的资料类型3]

### 案例素材
- [ ] [需要的具体案例1]
- [ ] [需要的具体案例2]

### 数据支撑
- [ ] [需要的统计数据1]
- [ ] [需要的统计数据2]

## ✅ 质量检查点
- [ ] 是否符合规范要求的字数范围
- [ ] 核心观点是否清晰表达
- [ ] 逻辑结构是否合理流畅
- [ ] 实例和数据是否充分支撑观点
- [ ] 语言风格是否符合目标读者

---

**📌 下一步建议：**
完成内容计划后，建议使用 \`/task\` 命令将此计划分解为具体的可执行写作任务。

请基于提供的写作规范，严格按照上述格式生成详细、可操作的内容计划。`
    },

    allowedTools: [
      'write_article', 'citation_manager', 'content_analyzer',
      'research_analyzer', 'time_estimator', 'todo_write', 'exit_plan_mode'
    ],
    progressMessage: '正在生成详细内容计划...',
    userFacingName: () => 'plan'
  },

  {
    type: 'prompt',
    name: 'task',
    description: '将内容计划分解为可执行任务',
    aliases: ['任务', '任务分解', 'tasks'],
    usage: '/task [基于前一步计划] 或 /task <计划内容>',
    examples: [
      '/task',
      '/task 基于刚才的内容计划',
      '/task 请分解"技术文章写作"的具体任务'
    ],
    
    async getPromptForCommand(_args: string, _context: AgentContext): Promise<string> {
      const taskInput = _args.trim()
      
      return `请将内容计划分解为具体的可执行写作任务：

${taskInput ? `任务输入：${taskInput}` : '请基于之前生成的内容计划进行任务分解。'}

## 🎯 任务分解要求

### 阶段1: 计划理解
- 深入理解内容计划的结构和要求
- 识别关键的写作节点和难点
- 确定任务的优先级和依赖关系

### 阶段2: 任务分解
将写作过程分解为以下格式的具体任务：

# 📋 写作任务分解

## 🚀 阶段一：准备与研究 (建议总时间: [X小时])

### Task 1: 素材收集与研究
**任务描述**: [具体的素材收集任务]
**具体行动**:
- [ ] 搜索并阅读相关资料 [时间: X分钟]
- [ ] 收集案例和数据 [时间: X分钟]  
- [ ] 整理核心参考文献 [时间: X分钟]

**成功标准**: [完成的标准]
**工具建议**: \`/research <主题>\` 或 \`/deep-research <主题>\`

### Task 2: 素材整理与分析
**任务描述**: [素材分析和整理任务]
**具体行动**:
- [ ] 分析收集的资料，提取关键信息
- [ ] 整理支撑观点的证据和案例
- [ ] 准备引用清单

**成功标准**: [完成的标准]
**预估时间**: [X分钟]

## ✍️ 阶段二：核心写作 (建议总时间: [X小时])

### Task 3: 引言部分写作
**任务描述**: 完成文章引言的写作
**具体内容**:
- [ ] 写作吸引人的开篇 ([X]字)
- [ ] 阐述核心问题 ([X]字)  
- [ ] 说明文章价值 ([X]字)
- [ ] 提供内容导航 ([X]字)

**写作提示**: [具体的写作建议和注意事项]
**工具建议**: \`/write "引言：[具体描述]"\`
**预估时间**: [X分钟]

### Task 4: 第一章节写作
**任务描述**: [第一章节的具体写作任务]
**具体内容**:
- [ ] [具体写作要点1] ([X]字)
- [ ] [具体写作要点2] ([X]字)
- [ ] [具体写作要点3] ([X]字)

**写作提示**: [针对该章节的写作建议]
**工具建议**: \`/write "[章节标题]：[具体描述]"\`
**预估时间**: [X分钟]

### Task 5: 第二章节写作
**任务描述**: [第二章节的具体写作任务]
**具体内容**:
- [ ] [具体写作要点] ([X]字)

**写作提示**: [写作建议]
**工具建议**: \`/write "[章节标题]：[具体描述]"\`
**预估时间**: [X分钟]

### Task 6: 第三章节写作
**任务描述**: [第三章节的具体写作任务]
**具体内容**:
- [ ] [具体写作要点] ([X]字)

**写作提示**: [写作建议]  
**工具建议**: \`/write "[章节标题]：[具体描述]"\`
**预估时间**: [X分钟]

### Task 7: 结论部分写作
**任务描述**: 完成文章结论的写作
**具体内容**:
- [ ] 总结核心观点 ([X]字)
- [ ] 提供实践建议 ([X]字)
- [ ] 展望未来发展 ([X]字)
- [ ] 呼吁读者行动 ([X]字)

**写作提示**: [结论写作建议]
**工具建议**: \`/write "结论：[具体描述]"\`
**预估时间**: [X分钟]

## 🔧 阶段三：优化与完善 (建议总时间: [X小时])

### Task 8: 内容审查与修改
**任务描述**: 全面审查和修改文章内容
**具体行动**:
- [ ] 检查逻辑结构和论证完整性
- [ ] 优化语言表达和句式结构  
- [ ] 确认事实数据和引用准确性
- [ ] 调整字数和段落分配

**工具建议**: \`/check <文章内容>\` 或 \`/polish <文章内容>\`
**预估时间**: [X分钟]

### Task 9: 格式整理与引用规范
**任务描述**: 完善格式和引用规范
**具体行动**:
- [ ] 统一标题格式和层级
- [ ] 整理参考文献格式
- [ ] 检查代码示例格式（如有）
- [ ] 优化整体视觉呈现

**预估时间**: [X分钟]

### Task 10: 最终检查与发布准备
**任务描述**: 最终质量检查和发布准备
**具体行动**:
- [ ] 完整通读，检查流畅性
- [ ] 对照写作规范检查完成度
- [ ] 准备发布格式（如需要）

**工具建议**: \`/format <目标格式> <文章>\`
**预估时间**: [X分钟]

## 📊 任务执行指南

### 执行顺序
建议严格按照 Task 1 → Task 2 → ... → Task 10 的顺序执行，确保写作质量。

### 时间管理
- **总预估时间**: [X小时Y分钟]
- **每日建议时间**: [根据计划建议每日写作时间]
- **里程碑检查**: 建议在 Task 3、Task 7、Task 10 完成后进行质量检查

### 质量控制
每个任务完成后，请检查：
- ✅ 是否达到字数要求
- ✅ 内容是否符合规范要求  
- ✅ 逻辑是否清晰流畅
- ✅ 是否为下一个任务做好准备

---

**📌 执行建议：**
1. 逐一完成每个任务，不要跳过
2. 使用建议的工具命令来提高写作效率
3. 完成每个任务后标记完成状态
4. 如遇到困难，可以使用 \`/help\` 获取更多命令帮助

请基于提供的内容计划，严格按照上述格式生成详细的任务分解，确保每个任务都具体可执行。`
    },
    
    allowedTools: [
      'write_article', 'task_manager', 'time_estimator',
      'content_analyzer', 'project_planner'
    ],
    progressMessage: '正在分解写作任务...',
    userFacingName: () => 'task'
  }
]